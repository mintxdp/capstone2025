#!/bin/bash
# === TOOL MAIN SCRIPT ===

# --- Resolve paths ---
BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$BIN_DIR/../lib"

# If installed globally, adjust library path
if [ -d "/usr/local/lib/tool" ]; then
    LIB_DIR="/usr/local/lib/tool"
fi

# --- Source dependencies ---
if [ -f "$LIB_DIR/loader.sh" ]; then
    source "$LIB_DIR/loader.sh"
elif [ -f "$LIB_DIR/logger.sh" ]; then
    source "$LIB_DIR/logger.sh"
    [ -f "$LIB_DIR/utils.sh" ] && source "$LIB_DIR/utils.sh"
else
    echo "Error: Could not load tool libraries from $LIB_DIR"
    exit 1
fi

UPDATE_CMD="$BIN_DIR/update"
BACKUP_CMD="$BIN_DIR/backup"

# If installed globally, override paths
[ -x "/usr/local/bin/update" ] && UPDATE_CMD="/usr/local/bin/update"
[ -x "/usr/local/bin/backup" ] && BACKUP_CMD="/usr/local/bin/backup"

# --- Help ---
show_help() {
cat <<EOF
Usage: tool [command] [options]

Commands:
  update              Perform system update
  backup              Perform system backup (full by default)
  backup -i|--incremental   Perform incremental backup
  backup -d|--disk <device> Perform disk backup
  backup -h|--help    Show backup help
  -h, --help          Show this help message

Examples:
  tool update
  tool backup
  tool backup -i
  tool backup --help
EOF
}

# --- Menu ---
show_menu() {
    echo "=============================="
    echo "       SYSTEM TOOL MENU       "
    echo "=============================="
    echo "1) Update system"
    echo "2) Backup system"
    echo "3) Exit"
    read -rp "Choose an option [1-3]: " choice

    case "$choice" in
        1) log_info "User chose system update"; "$UPDATE_CMD" ;;
        2) log_info "User chose system backup"; "$BACKUP_CMD" ;;
        3) log_info "User exited tool"; echo "Goodbye!"; exit 0 ;;
        *) log_error "Invalid option selected"; echo "Invalid choice." ;;
    esac
}

# --- Main ---
case "$1" in
    "" ) show_menu ;;
    -h|--help) show_help ;;
    update) shift; "$UPDATE_CMD" "$@" ;;
    backup) shift; "$BACKUP_CMD" "$@" ;;
    *) log_error "Unknown command: $1"; echo "Unknown command: $1"; exit 1 ;;
esac

